
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Daily Christian reflections and prayers">
    <title>The Daily Blessings</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="diff_match_patch.js"></script>
</head>
<body>
    <header>
        <h1>The Daily Blessings</h1>
    </header>

    <main>
        <section id="lords-prayer" class="content-box">
            <h2>The Lord's Prayer</h2>
            <p class="expected-sentence" id="lords-prayer-content">
                Our Father in heaven, hallowed be your name, your kingdom come, your will be done, on earth as it is in heaven.
                Give us today our daily bread. And forgive us our debts, as we also have forgiven our debtors. And lead us not 
                into temptation, but deliver us from the evil one. For yours is the kingdom, the power, and the glory, forever and ever. Amen.
            </p>
            <h3>Your Recognized Speech</h3>
            <p class="recognized-sentence" id="recognized-lords-prayer"></p>
            <div class="guided-reading-controls">
                <button id="start-reading-lords-prayer" class="guided-reading-button">Start Reading</button>
                <button id="stop-reading-lords-prayer" class="guided-reading-button" disabled>Stop Reading</button>
            </div>
            <div id="error-message-lords-prayer" class="error-message"></div>
        </section>

        <section id="bible-verse" class="content-box">
            <h2>Today's Bible Reading</h2>
            <p class="expected-sentence" id="bible-verse-content">Loading...</p>
            <h3>Your Recognized Speech</h3>
            <p class="recognized-sentence" id="recognized-bible-verse"></p>
            <div class="guided-reading-controls">
                <button id="start-reading-bible-verse" class="guided-reading-button">Start Reading</button>
                <button id="stop-reading-bible-verse" class="guided-reading-button" disabled>Stop Reading</button>
            </div>
            <div id="error-message-bible-verse" class="error-message"></div>
        </section>

        <section id="reflection" class="content-box">
            <h2>Reflection</h2>
            <p class="expected-sentence" id="reflection-content">Loading...</p>
            <h3>Your Recognized Speech</h3>
            <p class="recognized-sentence" id="recognized-reflection"></p>
            <div class="guided-reading-controls">
                <button id="start-reading-reflection" class="guided-reading-button">Start Reading</button>
                <button id="stop-reading-reflection" class="guided-reading-button" disabled>Stop Reading</button>
            </div>
            <div id="error-message-reflection" class="error-message"></div>
        </section>
    </main>

    <script>
        function setupSpeechRecognition(startBtnId, stopBtnId, expectedTextId, recognizedTextId, errorMsgId) {
            let recognition;

            document.getElementById(startBtnId).addEventListener("click", function() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    alert("Your browser does not support speech recognition.");
                    return;
                }

                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = "en-US";

                recognition.onstart = function() {
                    document.getElementById(startBtnId).disabled = true;
                    document.getElementById(stopBtnId).disabled = false;
                    document.getElementById(errorMsgId).innerText = "";
                };

                recognition.onresult = function(event) {
                    let transcript = Array.from(event.results).map(result => result[0].transcript).join(" ").trim().toLowerCase();

                    if (!transcript) {
                        document.getElementById(errorMsgId).innerText = "No words recognized. Try speaking clearly.";
                        return;
                    }

                    document.getElementById(errorMsgId).innerText = ""; // Clear error if words are recognized

                    if (typeof diff_match_patch === "undefined") {
                        document.getElementById(errorMsgId).innerText = "Error: diff-match-patch library not loaded.";
                        console.error("Error: diff-match-patch library not loaded.");
                        return;
                    }

                    const dmp = new diff_match_patch();
                    const expectedText = document.getElementById(expectedTextId).innerText.toLowerCase();
                    const diffs = dmp.diff_main(expectedText, transcript);
                    dmp.diff_cleanupSemantic(diffs);

                    let highlightedText = diffs.map(([type, text]) => {
                        return type === -1 ? `<span class="highlight">${text}</span>` : text;
                    }).join(" ");

                    document.getElementById(recognizedTextId).innerHTML = highlightedText;
                };

                recognition.onerror = function(event) {
                    document.getElementById(errorMsgId).innerText = `Error: ${event.error}. Please try again.`;
                    console.error("Speech Recognition Error:", event.error);
                };

                recognition.onend = function() {
                    document.getElementById(startBtnId).disabled = false;
                    document.getElementById(stopBtnId).disabled = true;
                };

                recognition.start();
            });

            document.getElementById(stopBtnId).addEventListener("click", function() {
                if (recognition) {
                    recognition.stop();
                }
            });
        }

        setupSpeechRecognition("start-reading-lords-prayer", "stop-reading-lords-prayer", "lords-prayer-content", "recognized-lords-prayer", "error-message-lords-prayer");
        setupSpeechRecognition("start-reading-bible-verse", "stop-reading-bible-verse", "bible-verse-content", "recognized-bible-verse", "error-message-bible-verse");
        setupSpeechRecognition("start-reading-reflection", "stop-reading-reflection", "reflection-content", "recognized-reflection", "error-message-reflection");

        async function loadDailyContent() {
            try {
                const response = await fetch('daily.json');
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.warn('Failed to load daily content:', error);
                return { "bible_verse": { "Psalms 23:1": "The Lord is my shepherd; I shall not want." },
                         "content": { "medium": ["Trust in God and His plan, for He provides all that we need."] } };
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const bibleVerseContent = document.getElementById('bible-verse-content');
            const reflectionContent = document.getElementById('reflection-content');

            const dailyContent = await loadDailyContent();
            const verseKey = Object.keys(dailyContent.bible_verse)[0];
            const verseText = dailyContent.bible_verse[verseKey];
            bibleVerseContent.textContent = `${verseKey}: ${verseText}`;
            reflectionContent.innerHTML = dailyContent.content.medium.join(" ");
        });
    </script>

    <style>
        .content-box {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 700px;
        }
        .guided-reading-button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background-color: crimson;
            color: white;
            cursor: pointer;
        }
        .guided-reading-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</body>
</html>
